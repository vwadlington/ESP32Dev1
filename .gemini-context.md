# Gemini Project Context: ESP32-S3 Smart Home Controller

## 1. Project Identity & Hardware
- **Target Device:** ESP32-S3-LCD-EV-Board2 (Espressif)
- **Display Module:** Sub-board 3 (800x480 RGB interface)
- **Touch Controller:** GT1151
- **Storage:** 16MB Flash with a dedicated SPIFFS partition labeled `storage`.
- **Framework:** ESP-IDF v5.1+ (C Language)
- **UI Library:** LVGL v9.x (Strict adherence to v9 APIs).

## 2. Component Architecture & Rules

### A. minigui (UI Component)
* **Path:** `components/minigui/` (Standalone GitHub Repo)
* **Screen Management:** Non-persistent loading.
    * The `status_bar` and `content_area` are persistent.
    * When `minigui_switch_screen` is called, children of the content area must be cleared via `lv_obj_clean(content_area)` before the new screen is allocated to save RAM.
* **Layering:** Global UI elements (Hamburger menu, Navigation drawer) must reside on `lv_layer_top()`.
* **Hardware Decoupling:** `minigui` does not call BSP drivers directly. It uses a callback system (e.g., `minigui_brightness_cb_t`) registered in `main.c`.

#### **Architecture & Layout**
* **Root Structure:** Use a Vertical Flex Column (`main_container`) as the global wrapper.
    * **Row 1 (Status Bar):** Horizontal Flex Row. Fixed height or `lv_pct(12)`.
    * **Row 2 (Content Area):** Use `lv_obj_set_flex_grow(content_area, 1)` to fill all remaining vertical space.
* **Drawer Logic:** The navigation menu must be parented to `lv_layer_top()` so it overlays the persistent Status Bar and Content Area.
* **Square Constraints:**
    * **Radius:** Force `lv_obj_set_style_radius(obj, 0, 0)` on the Main Container, Status Bar, and Content Area to prevent background bleed-through.
    * **Buttons:** The Hamburger menu button must be a 1:1 square. Implement this via `LV_EVENT_SIZE_CHANGED` with a callback that sets `width` equal to the parent's calculated `height`.



#### **LVGL 9.4 Implementation Standards**
* **Logging:** Use `LV_LOG_INFO`, `LV_LOG_WARN`, and `LV_LOG_ERROR` directly. Do not include `esp_log.h` or use `ESP_LOGx` macros to maintain board-agnosticism.
* **Flex Reset:** When switching screens, use `lv_obj_set_style_flex_flow(obj, 0, 0)` to clear layout settings (Note: `LV_FLEX_FLOW_NONE` is not defined in this environment).
* **Screen Swapping:** Always call `lv_obj_clean(content_area)` before applying new layout flows or creating new child objects.

#### **Typography (STRICT)**
* Only the following fonts are available in the manifest. Do not use other sizes:
    * **Montserrat 14:** Body text, button labels, table data (Logs).
    * **Montserrat 28:** Screen titles (Status Bar) and section headers.
    * **Montserrat 48:** Hero numbers (Sensor values, large clocks).

### B. dlogger (Logging Component)
- **Path:** `components/dlogger/`
- **Functionality:** Unified stream for `ESP_LOG` and `LVGL_LOG`.
- **Storage Strategy:** Circular rotation of 2 files, max 1MB each.
- **Format:** Timestamps generated via `esp_timer_get_time()` for file naming.

### C. storage (Storage Component)
- **Path:** `components/storage/`
- **Mount Point:** `/storage` (SPIFFS).

## 3. Directory Structure
```text
.
├── components
│   ├── dlogger
│   │   ├── dlogger.c/h
│   │   └── CMakeLists.txt
│   ├── minigui
│   │   ├── include/minigui.h
│   │   ├── include/screens/ (screen_home.h, screen_logs.h, screen_settings.h)
│   │   ├── src/minigui.c
│   │   └── src/screens/ (screen_home.c, screen_logs.c, screen_settings.c)
│   └── storage
│       └── storage.c/h
├── main
│   ├── main.c
│   └── idf_component.yml
└── partitions.csv

## 4. Interaction Constraints
- **Thread Safety:** LVGL is not thread-safe. All GUI modifications (screen switches, widget updates) must be performed while holding the `bsp_display_lock()` or within the LVGL timer task.
- **V9 Handler Signature:** In LVGL v9, the log callback signature is strictly `void func(lv_log_level_t level, const char *buf)`. Do not use the deprecated v8 signature which included file/line/function parameters.
- **Memory Monitoring:** Always consider PSRAM vs SRAM. Large buffers (like the upcoming log ring buffer) should be heap-allocated, ideally in PSRAM if the hardware configuration allows.
- **Build Awareness:** Ignore `build/`, `managed_components/`, and `.git/` directories during context analysis; focus exclusively on source code and headers.
- **Error Handling:** Every file-system operation (SPIFFS) or memory allocation must include a null-check or `esp_err_t` validation.
- **Comments:** Don't delete all the comments during a code edit. Keep as many comments as possible when editing code.